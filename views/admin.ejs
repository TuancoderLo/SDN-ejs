<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %></title>
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@5"
      rel="stylesheet"
      type="text/css"
    />
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/stylesheets/style.css" />
    <style>
      .section {
        display: none;
      }
      .section.active {
        display: block;
      }

      /* Admin table polish */
      .table tr:hover td {
        background-color: hsl(var(--b2) / 0.35);
        transition: background-color 0.2s ease;
      }
      .badge-soft {
        background: hsl(var(--p) / 0.12);
        color: hsl(var(--p));
      }

      /* Performance optimized transitions */
      * {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      .admin-tab {
        will-change: opacity, transform;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
      }

      .tab.active {
        background: linear-gradient(135deg, hsl(var(--p)), hsl(var(--s)));
        color: white !important;
        transform: scale(1.05);
        box-shadow: 0 4px 15px hsl(var(--p) / 0.3);
      }

      .tab.active span {
        color: white !important;
      }

      .tab.active i {
        color: white !important;
      }

      .card {
        backdrop-filter: blur(10px);
        border: 1px solid hsl(var(--b3) / 0.5);
      }

      .btn {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        will-change: transform;
      }

      .btn:hover {
        transform: translateY(-1px);
      }

      .btn:active {
        transform: translateY(0);
      }

      /* Gradient text effect */
      .gradient-text {
        background: linear-gradient(
          135deg,
          hsl(var(--p)),
          hsl(var(--s)),
          hsl(var(--a))
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: hsl(var(--b2));
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, hsl(var(--p)), hsl(var(--s)));
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(
          135deg,
          hsl(var(--p) / 0.8),
          hsl(var(--s) / 0.8)
        );
      }

      /* Enhanced form inputs */
      .input:focus,
      .select:focus {
        box-shadow: 0 0 0 3px hsl(var(--p) / 0.2);
        border-color: hsl(var(--p));
      }

      /* Stats enhancement with performance optimization */
      .stat {
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
          box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        will-change: transform;
      }

      .stat:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px hsl(var(--b3) / 0.25);
      }

      /* Optimize table animations */
      .table tr {
        transition: background-color 0.15s ease;
      }

      .table tr:hover td {
        background-color: hsl(var(--b2) / 0.35);
      }

      /* Enhanced Modal Fixes */
      .modal {
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
      }

      .modal:target,
      .modal[open] {
        opacity: 1;
        visibility: visible;
      }

      .modal-box {
        transform: translateY(50px);
        transition: transform 0.3s ease;
        max-height: 90vh;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: hsl(var(--p)) transparent;
      }

      .modal:target .modal-box,
      .modal[open] .modal-box {
        transform: translateY(0);
      }

      /* Prevent body scroll when modal is open */
      body.modal-open {
        overflow: hidden;
        padding-right: 0;
      }

      /* Smooth tab transitions */
      .admin-tab {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .admin-tab:not(.hidden) {
        opacity: 1;
        transform: translateY(0);
      }

      /* Tab button enhancements */
      .tab {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
      }

      .tab::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.2),
          transparent
        );
        transition: left 0.5s;
      }

      .tab:hover::before {
        left: 100%;
      }

      /* Sidebar Styles */
      .sidebar-item {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid transparent;
      }

      .sidebar-item:hover {
        background: hsl(var(--b2) / 0.5);
        border-color: hsl(var(--p) / 0.2);
        transform: translateX(2px);
      }

      .sidebar-item.active {
        background: linear-gradient(135deg, hsl(var(--p) / 0.1), hsl(var(--s) / 0.1));
        border-color: hsl(var(--p) / 0.3);
        color: hsl(var(--p));
        font-weight: 600;
      }

      .sidebar-item.active .bg-primary\/10 {
        background: hsl(var(--p));
      }

      .sidebar-item.active .text-primary {
        color: white;
      }

      /* Profile Cards Enhancement */
      .profile-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        align-items: stretch;
      }

      .profile-card {
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 500px;
      }

      .profile-card .card-body {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .profile-card form {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .profile-card .space-y-5 {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        gap: 1.25rem;
      }

      .profile-card .form-control {
        height: 76px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      .profile-card .input,
      .profile-card .select {
        height: 48px !important;
        min-height: 48px !important;
        padding: 0.75rem 1rem !important;
        font-size: 0.875rem;
        border-width: 1px;
        border-radius: 0.5rem;
      }

      /* Force dropdown to open downward */
      .profile-card .select {
        position: relative;
      }

      .profile-card .select option {
        background: white;
        color: #374151;
        padding: 0.5rem;
      }

      /* Override DaisyUI dropdown behavior */
      .profile-card .dropdown,
      .profile-card .dropdown-content {
        position: static !important;
      }

      /* Ensure select dropdown opens downward */
      select.select-bordered,
      select.input-bordered {
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 1em;
        padding-right: 2.5rem;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
      }

      .profile-card .label {
        margin-bottom: 0.25rem;
        height: auto;
      }

      .profile-card .label-text {
        font-size: 0.875rem;
        font-weight: 600;
      }

      .profile-card .card-actions {
        margin-top: auto;
        padding-top: 2rem;
      }

      /* Ensure enough space for dropdown */
      .profile-card {
        min-height: 550px;
        overflow: visible;
      }

      .profile-card .card-body {
        overflow: visible;
        position: relative;
        z-index: 1;
      }

      .profile-card form {
        overflow: visible;
      }

      /* Fix select dropdown positioning */
      .profile-card .form-control:last-child {
        margin-bottom: 2rem;
      }

      /* Dashboard responsive */
      @media (max-width: 1024px) {
        .w-80 {
          width: 16rem;
        }
        
        .profile-grid {
          grid-template-columns: 1fr;
          gap: 1.5rem;
        }
      }

      @media (max-width: 768px) {
        .w-80 {
          width: 100%;
          position: absolute;
          top: 0;
          left: -100%;
          height: 100vh;
          z-index: 50;
          transition: left 0.3s ease;
        }
        
        .w-80.mobile-open {
          left: 0;
        }

        .profile-grid {
          grid-template-columns: 1fr;
          gap: 1rem;
        }

        .profile-card {
          min-height: 400px;
        }
      }
    </style>
  </head>
  <body class="bg-base-100">
    <%- include('partials/navbar') %>

    <main
      class="min-h-screen bg-gradient-to-b from-base-100 via-base-200/40 to-base-100"
    >
      <!-- Admin Section -->
      <section id="admin" class="section active">
        <div class="flex min-h-screen">
          <!-- Sidebar -->
          <div class="w-80 bg-white shadow-xl border-r border-base-300 flex-shrink-0">
            <!-- Sidebar Header -->
            <div class="p-6 border-b border-base-200">
              <div class="flex items-center space-x-4">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary to-secondary flex items-center justify-center shadow-lg">
                  <i class="fas fa-crown text-white text-lg"></i>
                </div>
                <div>
                  <h2 class="text-xl font-bold gradient-text">Admin Panel</h2>
                  <p class="text-sm text-base-content/60">Management Dashboard</p>
                </div>
              </div>
            </div>

            <!-- Navigation Menu -->
            <nav class="p-4 space-y-2 flex-1">
              <!-- Overview -->
              <div class="mb-6">
                <h3 class="text-xs font-semibold text-base-content/40 uppercase tracking-wider mb-3 px-3">Overview</h3>
                <button
                  class="sidebar-item active w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-left hover:bg-base-100 transition-all duration-200"
                  onclick="showAdminTab('dashboard')"
                >
                  <div class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center">
                    <i class="fas fa-chart-pie text-primary text-sm"></i>
                  </div>
                  <span class="font-medium">Dashboard</span>
                </button>
              </div>

              <!-- Management -->
              <div class="mb-6">
                <h3 class="text-xs font-semibold text-base-content/40 uppercase tracking-wider mb-3 px-3">Management</h3>
                <div class="space-y-1">
                  <button
                    class="sidebar-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-left hover:bg-base-100 transition-all duration-200"
                    onclick="showAdminTab('members')"
                  >
                    <div class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center">
                      <i class="fas fa-users text-blue-500 text-sm"></i>
                    </div>
                    <span class="font-medium">Members</span>
                  </button>
                  
                  <button
                    class="sidebar-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-left hover:bg-base-100 transition-all duration-200"
                    onclick="showAdminTab('brands')"
                  >
                    <div class="w-8 h-8 rounded-lg bg-pink-500/10 flex items-center justify-center">
                      <i class="fas fa-tags text-pink-500 text-sm"></i>
                    </div>
                    <span class="font-medium">Brands</span>
                  </button>
                  
                  <button
                    class="sidebar-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-left hover:bg-base-100 transition-all duration-200"
                    onclick="showAdminTab('perfumes')"
                  >
                    <div class="w-8 h-8 rounded-lg bg-teal-500/10 flex items-center justify-center">
                      <i class="fas fa-spray-can text-teal-500 text-sm"></i>
                    </div>
                    <span class="font-medium">Perfumes</span>
                  </button>
                </div>
              </div>

              <!-- Settings -->
              <div>
                <h3 class="text-xs font-semibold text-base-content/40 uppercase tracking-wider mb-3 px-3">Settings</h3>
                <button
                  class="sidebar-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-left hover:bg-base-100 transition-all duration-200"
                  onclick="showAdminTab('profile')"
                >
                  <div class="w-8 h-8 rounded-lg bg-orange-500/10 flex items-center justify-center">
                    <i class="fas fa-user-cog text-orange-500 text-sm"></i>
                  </div>
                  <span class="font-medium">Profile</span>
                </button>
              </div>
            </nav>

            <!-- Load Data Button -->
            <div class="p-4 border-t border-base-200 mt-auto">
              <button
                class="btn btn-primary w-full hover:btn-primary hover:text-white transition-all duration-300"
                onclick="loadAllAdminData()"
              >
                <i class="fas fa-sync-alt mr-2"></i>
                Load All Data
              </button>
            </div>
          </div>

          <!-- Main Content Area -->
          <div class="flex-1 flex flex-col min-h-screen">
            <!-- Top Header -->
            <div class="bg-white shadow-sm border-b border-base-200 p-6">
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                  <!-- Mobile Menu Button -->
                  <button class="btn btn-ghost btn-sm lg:hidden" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                  </button>
                  <div>
                    <h1 class="text-2xl font-bold text-base-content" id="pageTitle">Dashboard</h1>
                    <p class="text-base-content/60" id="pageSubtitle">Overview of your admin panel</p>
                  </div>
                </div>
                <div class="flex items-center space-x-4">
                  <!-- Active Users section removed -->
                </div>
              </div>
            </div>

            <!-- Content Container -->
            <div class="flex-1 p-6 bg-base-50">
              
              <!-- Dashboard Tab -->
              <div id="adminDashboard" class="admin-tab">
                <div class="flex items-center justify-center min-h-[60vh]">
                  <div class="text-center max-w-2xl mx-auto">
                    <!-- Welcome Icon -->
                    <div class="mb-8">
                      <div class="w-24 h-24 mx-auto rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center shadow-xl">
                        <i class="fas fa-crown text-white text-3xl"></i>
                      </div>
                    </div>
                    
                    <!-- Welcome Message -->
                    <div class="mb-8">
                      <h1 class="text-4xl font-bold mb-4">
                        <span class="gradient-text">Chào mừng Admin</span>
                      </h1>
                      <p class="text-xl text-base-content/70 mb-6">
                        Chào mừng bạn quay trở lại với bảng điều khiển quản trị
                      </p>
                      <p class="text-base-content/60">
                        Sử dụng menu bên trái để quản lý thành viên, thương hiệu và nước hoa
                      </p>
                    </div>
                    
                    <!-- Quick Access Buttons -->
                    <div class="flex flex-wrap justify-center gap-4">
                      <button 
                        class="btn btn-primary btn-lg hover:scale-105 transition-all duration-300"
                        onclick="showAdminTab('members')"
                      >
                        <i class="fas fa-users mr-2"></i>
                        Quản lý thành viên
                      </button>
                      <button 
                        class="btn btn-secondary btn-lg hover:scale-105 transition-all duration-300"
                        onclick="showAdminTab('brands')"
                      >
                        <i class="fas fa-tags mr-2"></i>
                        Quản lý thương hiệu
                      </button>
                      <button 
                        class="btn btn-accent btn-lg hover:scale-105 transition-all duration-300"
                        onclick="showAdminTab('perfumes')"
                      >
                        <i class="fas fa-spray-can mr-2"></i>
                        Quản lý nước hoa
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Members Tab -->
              <div id="adminMembers" class="admin-tab hidden">
                <div class="bg-white rounded-xl shadow-sm p-6">
                  <div class="flex items-center justify-between mb-6">
                    <div>
                      <h3 class="text-lg font-semibold mb-1">All Members</h3>
                      <p class="text-base-content/60">Manage user accounts and permissions</p>
                    </div>
                    <button
                      class="btn btn-primary hover:scale-105 transition-transform duration-300"
                      onclick="loadMembers()"
                    >
                      <i class="fas fa-sync-alt mr-2"></i>
                      Refresh
                    </button>
                  </div>
                  
                  <div id="membersTable" class="rounded-xl overflow-hidden">
                    <!-- Members table will be loaded here -->
                  </div>
                </div>
              </div>

              <!-- Brands Tab -->
              <div id="adminBrands" class="admin-tab hidden">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div>
                      <h3 class="text-lg font-semibold mb-1">Brand Management</h3>
                      <p class="text-base-content/60">Add, edit, and organize perfume brands</p>
                    </div>
                    <div class="flex gap-3">
                      <button
                        class="btn btn-primary hover:scale-105 transition-transform duration-300"
                        onclick="showBrandForm()"
                      >
                        <i class="fas fa-plus mr-2"></i>
                        Add Brand
                      </button>
                      <button
                        class="btn btn-secondary hover:scale-105 transition-transform duration-300"
                        onclick="loadAdminBrands()"
                      >
                        <i class="fas fa-sync-alt mr-2"></i>
                        Refresh
                      </button>
                    </div>
                  </div>
                  <div id="brandsTable" class="rounded-xl overflow-hidden">
                    <!-- Brands table will be loaded here -->
                  </div>
                </div>
              </div>

              <!-- Perfumes Tab -->
              <div id="adminPerfumes" class="admin-tab hidden">
                <div class="bg-white rounded-xl shadow-sm p-6">
                  <div class="flex items-center justify-between mb-6">
                    <div>
                      <h3 class="text-lg font-semibold mb-1">Perfume Management</h3>
                      <p class="text-base-content/60">Manage your perfume collection and inventory
                    </div>
                    <div class="flex gap-3">
                      <button
                        class="btn btn-primary hover:scale-105 transition-transform duration-300"
                        onclick="showPerfumeForm()"
                      >
                        <i class="fas fa-plus mr-2"></i>
                        Add Perfume
                      </button>
                      <button
                        class="btn btn-secondary hover:scale-105 transition-transform duration-300"
                        onclick="loadAdminPerfumes()"
                      >
                        <i class="fas fa-sync-alt mr-2"></i>
                        Refresh
                      </button>
                    </div>
                  </div>
                  <div id="perfumesTable" class="rounded-xl overflow-hidden">
                    <!-- Perfumes table will be loaded here -->
                  </div>
                </div>
              </div>

              <!-- Profile Tab -->
              <div id="adminProfile" class="admin-tab hidden">
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                  <div class="flex items-center justify-between mb-6">
                    <div>
                      <h3 class="text-lg font-semibold mb-1">Profile Management</h3>
                      <p class="text-base-content/60">Manage your personal information and account settings</p>
                    </div>
                  </div>
                </div>

            <!-- Main Profile Grid -->
            <div class="profile-grid">
              <!-- Personal Information Card -->
              <div
                class="profile-card card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow duration-300"
              >
                <div class="card-body flex flex-col h-full">
                  <div class="flex items-center gap-3 mb-6">
                    <div
                      class="w-12 h-12 rounded-xl bg-gradient-to-br from-primary to-primary/80 flex items-center justify-center"
                    >
                      <i class="fas fa-user-edit text-white text-lg"></i>
                    </div>
                    <h2 class="card-title text-xl">Personal Information</h2>
                  </div>

                  <form id="profileForm" class="flex-1 flex flex-col">
                    <div class="space-y-5 flex-1">
                      <div class="form-control">
                        <label class="label">
                          <span
                            class="label-text font-semibold flex items-center gap-2"
                          >
                            <i class="fas fa-user text-primary"></i>
                            Full Name
                          </span>
                        </label>
                        <input
                          type="text"
                          id="profileName"
                          placeholder="Enter your full name"
                          class="input input-bordered input-primary focus:input-primary"
                          required
                        />
                      </div>

                      <div class="form-control">
                        <label class="label">
                          <span
                            class="label-text font-semibold flex items-center gap-2"
                          >
                            <i class="fas fa-calendar text-primary"></i>
                            Year of Birth
                          </span>
                        </label>
                        <input
                          type="number"
                          id="profileYOB"
                          min="1900"
                          max="2024"
                          placeholder="YYYY"
                          class="input input-bordered input-primary focus:input-primary"
                          required
                        />
                      </div>

                      <div class="form-control">
                        <label class="label">
                          <span
                            class="label-text font-semibold flex items-center gap-2"
                          >
                            <i class="fas fa-venus-mars text-primary"></i>
                            Gender
                          </span>
                        </label>
                        <select
                          id="profileGender"
                          class="select select-bordered select-primary focus:select-primary"
                          required
                        >
                          <option value="true">Male</option>
                          <option value="false">Female</option>
                        </select>
                      </div>
                    </div>

                    <div class="card-actions justify-center mt-auto pt-8">
                      <button
                        type="submit"
                        class="btn btn-primary btn-lg w-full"
                      >
                        <i class="fas fa-save mr-2"></i>
                        Update Profile
                      </button>
                    </div>
                  </form>
                </div>
              </div>

              <!-- Change Password Card -->
              <div
                class="profile-card card bg-base-100 shadow-xl hover:shadow-2xl transition-shadow duration-300"
              >
                <div class="card-body flex flex-col h-full">
                  <div class="flex items-center gap-3 mb-6">
                    <div
                      class="w-12 h-12 rounded-xl bg-gradient-to-br from-secondary to-secondary/80 flex items-center justify-center"
                    >
                      <i class="fas fa-lock text-white text-lg"></i>
                    </div>
                    <h2 class="card-title text-xl">Change Password</h2>
                  </div>

                  <form id="passwordForm" class="flex-1 flex flex-col">
                    <div class="space-y-5 flex-1">
                      <div class="form-control">
                        <label class="label">
                          <span
                            class="label-text font-semibold flex items-center gap-2"
                          >
                            <i class="fas fa-key text-secondary"></i>
                            Current Password
                          </span>
                        </label>
                        <input
                          type="password"
                          id="oldPassword"
                          placeholder="Enter current password"
                          class="input input-bordered input-secondary focus:input-secondary"
                          required
                        />
                      </div>

                      <div class="form-control">
                        <label class="label">
                          <span
                            class="label-text font-semibold flex items-center gap-2"
                          >
                            <i class="fas fa-shield-alt text-secondary"></i>
                            New Password
                          </span>
                        </label>
                        <input
                          type="password"
                          id="newPassword"
                          placeholder="Enter new password"
                          class="input input-bordered input-secondary focus:input-secondary"
                          required
                        />
                      </div>

                      <!-- Empty placeholder for equal height -->
                      <div class="form-control"></div>
                    </div>

                    <div class="card-actions justify-center mt-auto pt-8">
                      <button
                        type="submit"
                        class="btn btn-secondary btn-lg w-full"
                      >
                        <i class="fas fa-lock mr-2"></i>
                        Change Password
                      </button>
                    </div>
                  </form>
                </div>
              </div>

            </div>

            <!-- Quick Actions Section -->
            <div class="mt-12">
              <div
                class="card bg-gradient-to-r from-primary/5 to-secondary/5 border border-primary/10"
              >
                <div class="card-body text-center">
                  <h3 class="card-title justify-center text-xl mb-4">
                    <i class="fas fa-bolt text-accent"></i>
                    Quick Actions
                  </h3>
                  <div class="flex flex-wrap justify-center gap-4">
                    <button class="btn btn-outline btn-primary">
                      <i class="fas fa-download mr-2"></i>
                      Export Data
                    </button>
                    <button class="btn btn-outline btn-secondary">
                      <i class="fas fa-cog mr-2"></i>
                      Settings
                    </button>
                    <button class="btn btn-outline btn-accent">
                      <i class="fas fa-question-circle mr-2"></i>
                      Help
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <%- include('partials/modals') %> <%- include('partials/toast') %>

    <!-- Edit Brand Modal -->
    <dialog id="editBrandModal" class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Edit Brand</h3>
        <form id="editBrandForm">
          <div class="form-control">
            <label class="label">
              <span class="label-text">Brand Name</span>
            </label>
            <input
              type="text"
              id="editBrandName"
              name="brandName"
              class="input input-bordered"
              required
            />
          </div>
          <div class="modal-action">
            <button
              type="button"
              class="btn btn-ghost"
              onclick="closeEditBrandModal()"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">Update Brand</button>
          </div>
        </form>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>

    <script src="/javascripts/app.js"></script>

    <!-- Enhanced Modal Fix Script -->
    <script>
      // Smooth modal management with proper transitions
      function enhancedCloseModal() {
        return new Promise((resolve) => {
          // Remove body scroll lock immediately
          document.body.classList.remove("modal-open");
          document.body.style.overflow = "";
          document.body.style.paddingRight = "";

          // Find and close all open modals with transition
          const openModals = document.querySelectorAll(
            "dialog[open], .modal:target"
          );

          if (openModals.length === 0) {
            resolve();
            return;
          }

          openModals.forEach((modal, index) => {
            // Add closing animation
            modal.style.opacity = "0";
            const modalBox = modal.querySelector(".modal-box");
            if (modalBox) {
              modalBox.style.transform = "translateY(50px)";
            }

            // Close modal after animation
            setTimeout(() => {
              if (modal.close) {
                modal.close();
              }
              modal.removeAttribute("open");

              // Reset styles
              modal.style.opacity = "";
              if (modalBox) {
                modalBox.style.transform = "";
              }

              // Resolve on last modal
              if (index === openModals.length - 1) {
                resolve();
              }
            }, 300);
          });

          // Reset all forms
          setTimeout(() => {
            const forms = document.querySelectorAll("form");
            forms.forEach((form) => {
              if (form.id === "brandForm" || form.id === "perfumeForm") {
                form.reset();
                delete form.dataset.mode;
                delete form.dataset.perfumeId;
              }
            });

            // Reset modal titles
            const modalTitles = document.querySelectorAll(
              "#perfumeFormModal h3, #brandFormModal h3"
            );
            modalTitles.forEach((title) => {
              if (title.textContent.includes("Edit")) {
                if (title.closest("#perfumeFormModal")) {
                  title.textContent = "Add New Perfume";
                } else if (title.closest("#brandFormModal")) {
                  title.textContent = "Add New Brand";
                }
              }
            });
          }, 100);
        });
      }

      // Smooth modal opening
      function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          // Add body scroll lock
          document.body.classList.add("modal-open");

          // Show modal with animation
          modal.showModal();

          // Prevent immediate closure
          setTimeout(() => {
            modal.setAttribute('data-opened', 'true');
          }, 100);

          // Trigger reflow and animate
          requestAnimationFrame(() => {
            modal.style.opacity = "1";
            const modalBox = modal.querySelector(".modal-box");
            if (modalBox) {
              modalBox.style.transform = "translateY(0)";
            }
          });

          // Stop any event propagation for modal content
          const modalBox = modal.querySelector(".modal-box");
          if (modalBox) {
            modalBox.addEventListener('click', function(e) {
              e.stopPropagation();
            });
          }
        }
      }

      // Override the existing functions
      window.closeModal = enhancedCloseModal;
      window.openModal = openModal;

      // Add event listeners for modal close buttons
      document.addEventListener("DOMContentLoaded", function () {
        // Handle modal backdrop clicks ONLY
        document.addEventListener("click", function (e) {
          // Only close modal if clicking directly on modal backdrop, not on modal content
          if (e.target.classList.contains("modal-backdrop")) {
            enhancedCloseModal();
          }
        });

        // Handle escape key
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            enhancedCloseModal();
          }
        });

        // Prevent ALL modal content clicks from closing modal
        document.addEventListener("click", function (e) {
          // If click is inside any modal content, prevent any closure
          if (e.target.closest(".modal-box") || e.target.closest(".modal-content")) {
            e.stopPropagation();
            e.preventDefault();
            return false;
          }
        });
      });

      // Enhanced tab switching with sidebar navigation
      function showAdminTab(tabName) {
        return new Promise(async (resolve) => {
          // Close any open modals first
          await enhancedCloseModal();

          // Update page title and subtitle
          const pageTitle = document.getElementById('pageTitle');
          const pageSubtitle = document.getElementById('pageSubtitle');
          
          const tabInfo = {
            members: { title: 'Members', subtitle: 'Manage user accounts and permissions' },
            brands: { title: 'Brands', subtitle: 'Add, edit, and organize perfume brands' },
            perfumes: { title: 'Perfumes', subtitle: 'Manage your perfume collection and inventory' },
            profile: { title: 'Profile', subtitle: 'Manage your personal information and account settings' },
            dashboard: { title: 'Dashboard', subtitle: 'Overview of your admin panel' }
          };
          
          if (pageTitle && tabInfo[tabName]) {
            pageTitle.textContent = tabInfo[tabName].title;
            pageSubtitle.textContent = tabInfo[tabName].subtitle;
          }

          // Get all tabs and sidebar items
          const tabs = document.querySelectorAll(".admin-tab");
          const sidebarItems = document.querySelectorAll(".sidebar-item");
          const selectedTab = document.getElementById(
            "admin" + tabName.charAt(0).toUpperCase() + tabName.slice(1)
          );
          const activeButton = document.querySelector(
            `[onclick="showAdminTab('${tabName}')"]`
          );

          // Update sidebar active state
          sidebarItems.forEach((item) => item.classList.remove("active"));
          if (activeButton) {
            activeButton.classList.add("active");
          }

          // Hide current tabs with fade out
          tabs.forEach((tab) => {
            if (!tab.classList.contains("hidden")) {
              tab.style.opacity = "0";
              tab.style.transform = "translateY(20px)";
            }
          });

          // After fade out, hide tabs and show new one
          setTimeout(() => {
            tabs.forEach((tab) => {
              tab.classList.add("hidden");
              tab.style.opacity = "";
              tab.style.transform = "";
            });

            if (selectedTab) {
              selectedTab.classList.remove("hidden");
              // Trigger reflow for smooth animation
              selectedTab.offsetHeight;
            }

            resolve();
          }, 200);
        });
      }

      // Mobile sidebar toggle
      function toggleSidebar() {
        const sidebar = document.querySelector('.w-80');
        sidebar.classList.toggle('mobile-open');
      }

      // Enhanced page initialization
      document.addEventListener("DOMContentLoaded", function () {
        // Optimize transitions
        document.body.style.transition = "padding-right 0.3s ease";

        // Additional safety: Handle modal backdrop clicks with debouncing
        let backdropClickTimeout;
        document.addEventListener("click", function (e) {
          // Only handle if it's a direct modal backdrop click
          if (e.target.classList.contains("modal-backdrop")) {
            clearTimeout(backdropClickTimeout);
            backdropClickTimeout = setTimeout(() => {
              enhancedCloseModal();
            }, 50);
          }
        });

        // Handle escape key with debouncing
        let escapeKeyTimeout;
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            clearTimeout(escapeKeyTimeout);
            escapeKeyTimeout = setTimeout(() => {
              enhancedCloseModal();
            }, 10);
          }
        });

        // Initialize dashboard tab
        showAdminTab("dashboard");
      });
    </script>
  </body>
</html>
